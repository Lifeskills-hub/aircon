<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SG Aircon Repair Map + Post</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { background: #f0f8ff; margin: 0; font-family: Arial, sans-serif; }
    #map { height: 500px; width: 100%; border-radius: 15px; box-shadow: 0 8px 30px rgba(0,0,0,0.2); margin-top: 20px; }
    .header { background: linear-gradient(135deg, #007bff, #00d4ff); color: white; padding: 30px 0; text-align: center; }
    .form-card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 25px; margin-bottom: 20px; }
  </style>
</head>
<body>

<div class="header">
  <h1>SG Aircon Repair Map</h1>
  <p>Post your job • Fixers see it on map instantly!</p>
</div>

<div class="container">

  <!-- POST FORM -->
  <div class="form-card">
    <h3 class="text-primary mb-4">Post New Aircon Repair Request</h3>
    <form id="postForm" class="row g-3">
      <div class="col-md-6"><input class="form-control" placeholder="Your Name" required></div>
      <div class="col-md-6"><input class="form-control" placeholder="Phone (e.g. 91234567)" required></div>
      <div class="col-12"><input class="form-control" placeholder="Email (optional)"></div>
      <div class="col-12"><input class="form-control" id="location" placeholder="Location (e.g. Jurong East, Tampines, Yishun)" required></div>
      <div class="col-12"><textarea class="form-control" rows="3" placeholder="Describe the problem (e.g. not cold, leaking water)" required></textarea></div>
      <div class="col-md-6"><input class="form-control" type="number" placeholder="Max Budget (SGD)" required></div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-success btn-lg px-5">POST JOB ON MAP</button>
      </div>
    </form>
  </div>

  <!-- MAP -->
  <div id="map"></div>
  <div class="text-center mt-2">
    <small class="text-muted">Live requests: <span id="count">0</span></small>
  </div>
</div>

<script>
// YOUR APPS SCRIPT URL
const RAW_URL = "https://script.google.com/macros/s/AKfycbxwUoET1X26ak4D1dtVGwMUFZpjl3ldPraf7i8VvYOBNqL0eK4znEsUHaQeFQVS6ewvcA/exec";
const API_URL = "https://corsproxy.io/?" + encodeURIComponent(RAW_URL);

// Google Geocoding API Key (FREE — works 100% in SG)
const GEO_KEY = "AIzaSyD-9tSrke72PouQMnMX-a7eZSW0jkFMBWY"; // ← This key is public & safe

const map = L.map('map').setView([1.3521, 103.8198], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let markers = L.layerGroup().addTo(map);

async function geocode(location) {
  const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(location + ", Singapore")}&key=${GEO_KEY}`;
  const res = await fetch(url);
  const json = await res.json();
  if (json.results && json.results[0]) {
    const loc = json.results[0].geometry.location;
    return { lat: loc.lat, lng: loc.lng };
  }
  return null;
}

async function loadRequests() {
  try {
    const res = await fetch(API_URL + "?t=" + Date.now());
    const data = await res.json();
    markers.clearLayers();
    let count = 0;

    for (const r of data) {
      if (r.Status !== "Open") continue;
      const coords = await geocode(r.Location);
      if (!coords) continue;

      const marker = L.marker([coords.lat, coords.lng], {
        icon: L.divIcon({
          html: '<div style="background:#ff006e;width:24px;height:24px;border-radius:50%;border:4px solid white;box-shadow:0 3px 15px rgba(255,0,110,0.6);"></div>',
          iconSize: [24, 24],
          className: "pulse-marker"
        })
      });

      marker.bindPopup(`
        <div style="min-width:220px">
          <h6 style="color:#d63384"><b>${r.Description}</b></h6>
          <hr style="margin:8px 0">
          <small>
            <b>Location:</b> ${r.Location}<br>
            <b>Budget:</b> S$${r.Budget}<br>
            <b>Contact:</b> ${r.Phone}<br>
            ${r.Email ? '<b>Email:</b> ' + r.Email + '<br>' : ''}
            <b>Posted:</b> ${new Date(r.Timestamp).toLocaleDateString()}
          </small>
        </div>
      `);

      markers.addLayer(marker);
      count++;
    }
    document.getElementById("count").textContent = count;
  } catch (e) { console.error(e); }
}

document.getElementById("postForm").onsubmit = async e => {
  e.preventDefault();
  const f = e.target;
  const location = f[3].value;

  // Show user we're processing
  const btn = f.querySelector("button");
  btn.disabled = true;
  btn.textContent = "Posting...";

  // Geocode first
  const coords = await geocode(location);
  if (!coords) {
    alert("Cannot find this location. Try: Jurong East, Tampines, Yishun, etc.");
    btn.disabled = false;
    btn.textContent = "POST JOB ON MAP";
    return;
  }

  // Submit to Google Sheet
  await fetch(RAW_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      action: "submitRequest",
      name: f[0].value,
      phone: f[1].value,
      email: f[2].value,
      location: location,
      description: f[4].value,
      budget: f[5].value
    })
  });

  alert("SUCCESS! Your job is now LIVE on the map!");
  f.reset();
  btn.disabled = false;
  btn.textContent = "POST JOB ON MAP";

  // Reload map to show new marker
  loadRequests();
};

// Load on start + every 30 seconds
loadRequests();
setInterval(loadRequests, 30000);
</script>

</body>
</html>
