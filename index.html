<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SG Aircon Repair Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { background: #f0f8ff; margin: 0; font-family: Arial; }
    #map { height: 600px; width: 100%; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); margin: 25px 0; }
    .header { background: linear-gradient(135deg, #007bff, #00c6ff); color: white; padding: 40px 0; text-align: center; }
    .form-card { background: white; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); padding: 35px; margin: 20px auto; max-width: 800px; }
    .pulse { background: #ff0000; width: 32px; height: 32px; border-radius: 50%; border: 6px solid white; box-shadow: 0 0 0 0 rgba(255,0,0,1); animation: pulse 2s infinite; }
    .confirmed { background: #28a745; width: 32px; height: 32px; border-radius: 50%; border: 6px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); } 70% { box-shadow: 0 0 0 25px rgba(255,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); } }
    #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 99999; }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div style="background:white;padding:40px;border-radius:20px;text-align:center;max-width:400px;">
    <h3>SG Aircon Repair Map</h3>
    <p>Enter any password to continue<br><small>(Everyone uses the same password)</small></p>
    <input type="password" id="passInput" class="form-control mb-3" placeholder="Password">
    <button class="btn btn-primary btn-lg" onclick="login()">Enter</button>
  </div>
</div>

<div class="header" style="display:none" id="mainHeader">
  <h1>SG Aircon Repair Map</h1>
  <p id="userInfo">Welcome! You are viewing as: <b>Fixer</b></p>
</div>

<div class="container" style="display:none" id="mainContent">
  <div class="form-card">
    <h3 class="text-primary">Post New Job</h3>
    <form id="postForm" class="row g-3">
      <div class="col-md-6"><input class="form-control" placeholder="Your Name" required></div>
      <div class="col-md-6"><input class="form-control" placeholder="Your Phone (for confirming later)" required></div>
      <div class="col-12"><input class="form-control" placeholder="Email (optional)"></div>
      <div class="col-12">
        <select class="form-select" required>
          <option value="">Choose Area</option>
          <option>Jurong East</option><option>Tampines</option><option>Yishun</option><option>Bedok</option>
          <option>Woodlands</option><option>Ang Mo Kio</option><option>Bukit Batok</option><option>Choa Chu Kang</option>
          <option>Sengkang</option><option>Punggol</option><option>Hougang</option><option>Clementi</option>
          <option>Bukit Panjang</option>
        </select>
      </div>
      <div class="col-12"><textarea class="form-control" rows="3" placeholder="Problem Description" required></textarea></div>
      <div class="col-md-6"><input class="form-control" type="number" placeholder="Budget SGD" required></div>
      <div class="col-12 text-end"><button type="submit" class="btn btn-primary btn-lg">POST JOB</button></div>
    </form>
  </div>
  <div id="map"></div>
  <div class="text-center mb-4"><h5 class="text-primary">Open Jobs: <span id="count">0</span></h5></div>
</div>

<script>
// CHANGE THIS PASSWORD (tell your fixers!)
const MASTER_PASSWORD = "aircon123";

// UPDATE THIS AFTER DEPLOY
const BASE_URL = "https://script.google.com/macros/s/AKfycbxwUoET1X26ak4D1dtVGwMUFZpjl3ldPraf7i8VvYOBNqL0eK4znEsUHaQeFQVS6ewvcA/exec";

let currentUserPhone = ""; // Only customer has this

function login() {
  const input = document.getElementById("passInput").value;
  if (input === MASTER_PASSWORD) {
    document.getElementById("loginScreen").remove();
    document.getElementById("mainHeader").style.display = "block";
    document.getElementById("mainContent").style.display = "block";
    load();
    setInterval(load, 30000);
  } else {
    alert("Wrong password!");
  }
}

function buildProxyUrl(params) {
  const url = new URL(BASE_URL);
  for (const [k, v] of Object.entries(params)) if (v) url.searchParams.set(k, v);
  return "https://corsproxy.io/?" + encodeURIComponent(url.toString());
}

const COORDS = { "jurong east": [1.3331, 103.7423], "tampines": [1.3532, 103.9454], "yishun": [1.4294, 103.8354], "bedok": [1.3235, 103.8973], "woodlands": [1.4369, 103.7865], "ang mo kio": [1.3698, 103.8466], "bukit batok": [1.3491, 103.7497], "choa chu kang": [1.3852, 103.7445], "sengkang": [1.3915, 103.8950], "punggol": [1.4052, 103.9024], "hougang": [1.3734, 103.8867], "clementi": [1.3148, 103.7649], "bukit panjang": [1.3786, 103.7623] };

const map = L.map('map').setView([1.3521, 103.8198], 11);
L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { attribution: 'Â© Google' }).addTo(map);
let markers = L.layerGroup().addTo(map);

async function load() {
  try {
    const res = await fetch(buildProxyUrl({ action: "getAll" }));
    const data = await res.json();
    if (!Array.isArray(data)) return;

    markers.clearLayers();
    let openCount = 0;

    data.forEach(r => {
      const loc = (r.Location || "").toLowerCase().trim();
      const coord = COORDS[loc] || COORDS["jurong east"];
      if (!coord) return;

      const isConfirmed = r.Status === "Confirmed";
      const hasOffers = Array.isArray(r.Offers) && r.Offers.length > 0;
      const isCustomer = currentUserPhone && r.Phone === currentUserPhone;

      if (!isConfirmed) openCount++;

      const icon = isConfirmed
        ? L.divIcon({ className: "confirmed", html: "Check", iconSize: [32, 32] })
        : L.divIcon({ className: "pulse", html: "", iconSize: [32, 32] });

      let buttonHtml = "";
      if (isConfirmed) {
        buttonHtml = `<b style="color:green">Confirmed with ${r.ConfirmedFixerName}</b>`;
      } else if (hasOffers && isCustomer) {
        buttonHtml = `<button class="btn btn-warning btn-sm" onclick='showOffers("${r.Id}", ${JSON.stringify(r.Offers)}, "${r.Phone}")'>Choose Fixer (${r.Offers.length} offers)</button>`;
      } else if (hasOffers) {
        buttonHtml = `<button class="btn btn-secondary btn-sm" disabled>${r.Offers.length} offer${r.Offers.length>1?'s':''}</button> `;
        buttonHtml += `<button class="btn btn-success btn-sm" onclick="showAcceptForm('${r.Id}')">Submit Offer</button>`;
      } else {
        buttonHtml = `<button class="btn btn-success btn-sm" onclick="showAcceptForm('${r.Id}')">Submit Offer</button>`;
      }

      const popupContent = `
        <b style="color:${isConfirmed ? 'green' : 'red'}">${r.Description}</b><hr>
        <b>Name:</b> ${r.Name}<br>
        <b>Phone:</b> ${r.Phone}<br>
        <b>Location:</b> ${r.Location}<br>
        <b>Budget:</b> S$${r.Budget}<br>
        ${isCustomer ? '<b style="color:green">You posted this job</b><br>' : ''}
        <small>Status: <b>${r.Status || 'Open'}</b></small><br><br>
        ${buttonHtml}
      `;

      L.marker(coord, { icon }).bindPopup(popupContent).addTo(markers);
    });

    document.getElementById("count").textContent = openCount;
  } catch (e) { console.error(e); }
}

function showAcceptForm(id) {
  // same as before
  const html = `...`; // (same modal as before - I'll keep it short)
  // use previous showAcceptForm code
}

function showOffers(requestId, offers, customerPhone) {
  if (currentUserPhone !== customerPhone) {
    alert("Only the customer who posted this job can choose a fixer!");
    return;
  }
  // show list + confirm button
  // use previous showOffers + confirmFixer
}

// Keep all other functions: submitOffer, confirmFixer, postForm, etc.
// (exactly same as last working version)

document.getElementById("postForm").onsubmit = async function(e) {
  e.preventDefault();
  const f = e.target;
  currentUserPhone = f[1].value; // Save phone for customer mode
  document.getElementById("userInfo").innerHTML = `Welcome! You posted a job (Phone: ${currentUserPhone})`;
  // submit request same as before
};
