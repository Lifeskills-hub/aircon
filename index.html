<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SG Aircon Repair Map - FINAL & PERFECT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { background: #f0f8ff; margin: 0; font-family: Arial; }
    #map { height: 580px; width: 100%; border-radius: 18px; box-shadow: 0 15px 40px rgba(0,0,0,0.25); margin: 25px 0; }
    .header { background: linear-gradient(135deg, #11998e, #38ef7d); color: white; padding: 40px 0; text-align: center; }
    .form-card { background: white; border-radius: 18px; box-shadow: 0 15px 40px rgba(0,0,0,0.15); padding: 35px; margin-bottom: 20px; }
    .marker-pulse { background:#ff0000; width:30px; height:30px; border-radius:50%; border:5px solid white; box-shadow:0 0 0 0 rgba(255,0,0,1); animation:pulse 2s infinite; }
    @keyframes pulse { 0% { box-shadow:0 0 0 0 rgba(255,0,0,0.7); } 70% { box-shadow:0 0 0 20px rgba(255,0,0,0); } 100% { box-shadow:0 0 0 0 rgba(255,0,0,0); } }
  </style>
</head>
<body>

<div class="header">
  <h1>SG Aircon Repair Map</h1>
  <p>Real-time jobs • Real Singapore map • Fixers click & call instantly!</p>
</div>

<div class="container">
  <div class="form-card">
    <h3 class="text-success mb-4">Post New Aircon Repair Job</h3>
    <form id="postForm" class="row g-3">
      <div class="col-md-6"><input class="form-control" placeholder="Your Name" required></div>
      <div class="col-md-6"><input class="form-control" placeholder="Phone (e.g. 91234567)" required></div>
      <div class="col-12"><input class="form-control" placeholder="Email (optional)"></div>
      <div class="col-12">
        <select class="form-select form-select-lg" id="location" required>
          <option value="">Choose Your Area</option>
          <option>Ang Mo Kio</option><option>Bedok</option><option>Bishan</option><option>Bukit Batok</option>
          <option>Bukit Merah</option><option>Bukit Panjang</option><option>Choa Chu Kang</option><option>Clementi</option>
          <option>Hougang</option><option>Jurong East</option><option>Jurong West</option><option>Pasir Ris</option>
          <option>Punggol</option><option>Sembawang</option><option>Sengkang</option><option>Tampines</option>
          <option>Toa Payoh</option><option>Woodlands</option><option>Yishun</option>
        </select>
      </div>
      <div class="col-12"><textarea class="form-control" rows="3" placeholder="Problem (e.g. not cold, leaking, noisy)" required></textarea></div>
      <div class="col-md-6"><input class="form-control" type="number" placeholder="Max Budget (SGD)" required></div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-danger btn-lg px-5">POST JOB ON MAP</button>
      </div>
    </form>
  </div>

  <div id="map"></div>
  <div class="text-center mt-3">
    <h5>Live Jobs: <span id="count" class="text-danger">0</span></h5>
  </div>
</div>

<script>
// YOUR APPS SCRIPT URL
const RAW_URL = "https://script.google.com/macros/s/AKfycbxwUoET1X26ak4D1dtVGwMUFZpjl3ldPraf7i8VvYOBNqL0eK4znEsUHaQeFQVS6ewvcA/exec";
const API_URL = "https://corsproxy.io/?" + encodeURIComponent(RAW_URL);

// REAL SINGAPORE COORDINATES (HDB town centers)
const COORDS = {
  "Ang Mo Kio": [1.3698, 103.8466], "Bedok": [1.3235, 103.9273], "Bishan": [1.3511, 103.8481],
  "Bukit Batok": [1.3491, 103.7497], "Bukit Merah": [1.2811, 103.8231], "Bukit Panjang": [1.3786, 103.7623],
  "Choa Chu Kang": [1.3852, 103.7445], "Clementi": [1.3148, 103.7649], "Hougang": [1.3734, 103.8867],
  "Jurong East": [1.3331, 103.7423], "Jurong West": [1.3396, 103.7074], "Pasir Ris": [1.3731, 103.9493],
  "Punggol": [1.4052, 103.9024], "Sembawang": [1.4491, 103.8200], "Sengkang": [1.3915, 103.8950],
  "Tampines": [1.3532, 103.9454], "Toa Payoh": [1.3354, 103.8565], "Woodlands": [1.4369, 103.7865],
  "Yishun": [1.4294, 103.8354]
};

// BETTER MAP TILES (Google Maps style)
const map = L.map('map').setView([1.3521, 103.8198], 11);
L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
  attribution: '© Google Maps'
}).addTo(map);

let markers = L.layerGroup().addTo(map);

async function loadRequests() {
  try {
    const res = await fetch(API_URL + "?t=" + Date.now());
    const data = await res.json();
    markers.clearLayers();
    let count = 0;

    data.forEach(r => {
      if (r.Status !== "Open") return;

      // FIX YOUR SHEET'S MIXED-UP COLUMNS
      const name = r.Name || r["Status"] || "Unknown";
      const phone = r.Phone || r["Name"] || "No phone";
      const location = r.Location || r["Email"] || "Unknown";
      const problem = r.Description || r["Location"] || "No problem";
      const budget = r.Budget || r["Problem"] || "TBC";
      const status = r.Status || "Open";

      const coord = COORDS[location];
      if (!coord) return;

      const marker = L.marker(coord, {
        icon: L.divIcon({ className: "marker-pulse", html: "", iconSize: [30, 30] })
      });

      marker.bindPopup(`
        <div style="font-size:14px">
          <h6 style="color:#d63384; margin:0"><b>${problem}</b></h6>
          <hr style="margin:6px 0">
          <b>Name:</b> ${name}<br>
          <b>Phone:</b> <a href="tel:${phone}">${phone}</a><br>
          <b>Location:</b> ${location}<br>
          <b>Budget:</b> S$${budget}<br>
          <small>Posted: ${new Date(r.Timestamp).toLocaleDateString()}</small>
        </div>
      `);

      markers.addLayer(marker);
      count++;
    });

    document.getElementById("count").textContent = count;
  } catch (e) { console.error(e); }
}

document.getElementById("postForm").onsubmit = async e => {
  e.preventDefault();
  const f = e.target;
  const location = f[3].value;
  const btn = f.querySelector("button");
  btn.disabled = true;
  btn.textContent = "Posting...";

  if (!COORDS[location]) {
    alert("Please select a valid location from the list!");
    btn.disabled = false; btn.textContent = "POST JOB ON MAP"; return;
  }

  await fetch(RAW_URL, {
    method: "POST", mode: "no-cors",
    body: JSON.stringify({
      action: "submitRequest",
      name: f[0].value,
      phone: f[1].value,
      email: f[2].value,
      location: location,
      description: f[4].value,
      budget: f[5].value
    })
  });

  alert("SUCCESS! Your job is LIVE on the map!");
  f.reset();
  btn.disabled = false;
  btn.textContent = "POST JOB ON MAP";
  loadRequests();
};

// Load now + refresh every 30s
loadRequests();
setInterval(loadRequests, 30000);
</script>

</body>
</html>
