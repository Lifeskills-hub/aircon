<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SG Aircon Repair Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { background: #f0f8ff; margin: 0; font-family: Arial; }
    #map { height: 600px; width: 100%; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.3); margin: 25px 0; }
    .header { background: linear-gradient(135deg, #007bff, #00c6ff); color: white; padding: 40px 0; text-align: center; }
    .form-card { background: white; border-radius: 20px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); padding: 35px; margin: 20px auto; max-width: 800px; }
    .pulse { background: #ff0000; width: 32px; height: 32px; border-radius: 50%; border: 6px solid white; box-shadow: 0 0 0 0 rgba(255,0,0,1); animation: pulse 2s infinite; }
    .confirmed { background: #28a745; width: 32px; height: 32px; border-radius: 50%; border: 6px solid white; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 20px; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(255,0,0,0.7); } 70% { box-shadow: 0 0 0 25px rgba(255,0,0,0); } 100% { box-shadow: 0 0 0 0 rgba(255,0,0,0); } }
    #loginScreen { position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.9);display:flex;justify-content:center;align-items:center;z-index:99999; }
  </style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
  <div style="background:white;padding:40px;border-radius:20px;text-align:center;max-width:400px;">
    <h3>SG Aircon Repair Map</h3>
    <p>Login with your username & password</p>
    <input type="text" id="username" class="form-control mb-3" placeholder="Username" autofocus>
    <input type="password" id="password" class="form-control mb-3" placeholder="Password">
    <button class="btn btn-primary btn-lg w-100" onclick="login()">Login</button>
    <small class="text-muted d-block mt-3">New? Just register below</small>
    <button class="btn btn-outline-success mt-2" onclick="showRegister()">Register New Account</button>
  </div>
</div>

<!-- REGISTER MODAL -->
<div id="registerModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:99999;justify-content:center;align-items:center;">
  <div style="background:white;padding:30px;border-radius:15px;max-width:400px;">
    <h5>Create Account</h5>
    <input type="text" id="regUser" class="form-control mb-2" placeholder="Choose Username">
    <input type="password" id="regPass" class="form-control mb-2" placeholder="Choose Password">
    <input type="text" id="regPhone" class="form-control mb-3" placeholder="Your Phone (for customer mode)">
    <div class="text-end">
      <button class="btn btn-secondary me-2" onclick="hideRegister()">Cancel</button>
      <button class="btn btn-success" onclick="register()">Create Account</button>
    </div>
  </div>
</div>

<div class="header" id="mainHeader" style="display:none">
  <h1>SG Aircon Repair Map</h1>
  <p id="userInfo">Welcome, <b id="usernameDisplay"></b>! | <a href="#" onclick="logout()" style="color:#fff">Logout</a></p>
</div>

<div class="container" id="mainContent" style="display:none">
  <div class="form-card">
    <h3 class="text-primary">Post New Job</h3>
    <form id="postForm" class="row g-3">
      <div class="col-md-6"><input class="form-control" placeholder="Your Name" required></div>
      <div class="col-md-6"><input class="form-control" id="customerPhone" placeholder="Your Phone (must match login)" required></div>
      <div class="col-12"><input class="form-control" placeholder="Email (optional)"></div>
      <div class="col-12">
        <select class="form-select" required>
          <option value="">Choose Area</option>
          <option>Jurong East</option><option>Tampines</option><option>Yishun</option><option>Bedok</option>
          <option>Woodlands</option><option>Ang Mo Kio</option><option>Bukit Batok</option><option>Choa Chu Kang</option>
          <option>Sengkang</option><option>Punggol</option><option>Hougang</option><option>Clementi</option>
          <option>Bukit Panjang</option>
        </select>
      </div>
      <div class="col-12"><textarea class="form-control" rows="3" placeholder="Problem Description" required></textarea></div>
      <div class="col-md-6"><input class="form-control" type="number" placeholder="Budget SGD" required></div>
      <div class="col-12 text-end"><button type="submit" class="btn btn-primary btn-lg">POST JOB</button></div>
    </form>
  </div>
  <div id="map"></div>
  <div class="text-center mb-5"><h5 class="text-primary">Open Jobs: <span id="count">0</span></h5></div>
</div>

<script>
// UPDATE THIS URL AFTER DEPLOYING
const BASE_URL = "https://script.google.com/macros/s/AKfycbxwUoET1X26ak4D1dtVGwMUFZpjl3ldPraf7i8VvYOBNqL0eK4znEsUHaQeFQVS6ewvcA/exec";

let currentUser = null;  // {username, phone}

function showRegister() { document.getElementById("registerModal").style.display = "flex"; }
function hideRegister() { document.getElementById("registerModal").style.display = "none"; }

async function register() {
  const user = document.getElementById("regUser").value.trim();
  const pass = document.getElementById("regPass").value;
  const phone = document.getElementById("regPhone").value.trim();
  if (!user || !pass || !phone) return alert("All fields required");

  const res = await fetch(buildProxyUrl({action:"register", user, pass, phone}));
  const json = await res.json();
  if (json.success) {
    alert("Account created! Now login");
    hideRegister();
  } else {
    alert("Error: " + json.error);
  }
}

async function login() {
  const user = document.getElementById("username").value.trim();
  const pass = document.getElementById("password").value;
  if (!user || !pass) return alert("Enter username & password");

  const res = await fetch(buildProxyUrl({action:"login", user, pass}));
  const json = await res.json();
  if (json.success) {
    currentUser = {username: user, phone: json.phone};
    localStorage.setItem("sgAirconUser", JSON.stringify(currentUser));
    document.getElementById("loginScreen").remove();
    document.getElementById("mainHeader").style.display = "block";
    document.getElementById("mainContent").style.display = "block";
    document.getElementById("usernameDisplay").textContent = user;
    load();
    setInterval(load, 30000);
  } else {
    alert("Wrong username or password!");
  }
}

function logout() {
  if (confirm("Logout?")) {
    localStorage.removeItem("sgAirconUser");
    location.reload();
  }
}

// Auto-login if saved
if (localStorage.getItem("sgAirconUser")) {
  currentUser = JSON.parse(localStorage.getItem("sgAirconUser"));
  document.getElementById("loginScreen").remove();
  document.getElementById("mainHeader").style.display = "block";
  document.getElementById("mainContent").style.display = "block";
  document.getElementById("usernameDisplay").textContent = currentUser.username;
  load();
  setInterval(load, 30000);
}

function buildProxyUrl(params) {
  const url = new URL(BASE_URL);
  Object.entries(params).forEach(([k,v]) => v && url.searchParams.set(k,v));
  return "https://corsproxy.io/?" + encodeURIComponent(url.toString());
}

// Rest of the map code (load, showOffers, submitOffer, etc.) is SAME as before
// Just add currentUser.phone instead of currentUserPhone

const COORDS = { /* same as before */ };
const map = L.map('map').setView([1.3521, 103.8198], 11);
L.tileLayer('https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}').addTo(map);
let markers = L.layerGroup().addTo(map);

async function load() {
  const res = await fetch(buildProxyUrl({action:"getAll"}));
  const data = await res.json();
  if (!Array.isArray(data)) return;

  markers.clearLayers();
  let openCount = 0;

  data.forEach(r => {
    const loc = (r.Location||"").toLowerCase().trim();
    const coord = COORDS[loc] || COORDS["jurong east"];
    if (!coord) return;

    const isConfirmed = r.Status === "Confirmed";
    const hasOffers = Array.isArray(r.Offers) && r.Offers.length > 0;
    const isCustomer = currentUser && r.Phone === currentUser.phone;

    if (!isConfirmed) openCount++;

    const icon = isConfirmed
      ? L.divIcon({className:"confirmed",html:"Check",iconSize:[32,32]})
      : L.divIcon({className:"pulse",html:"",iconSize:[32,32]});

    let buttonHtml = "";
    if (isConfirmed) {
      buttonHtml = `<b style="color:green">Confirmed with ${r.ConfirmedFixerName}</b>`;
    } else if (hasOffers && isCustomer) {
      buttonHtml = `<button class="btn btn-warning btn-sm fw-bold" onclick='showOffers("${r.Id}", ${JSON.stringify(r.Offers)}, "${r.Phone}")'>Choose Fixer (${r.Offers.length})</button>`;
    } else if (hasOffers) {
      buttonHtml = `<span class="text-muted me-2">${r.Offers.length} offers</span> <button class="btn btn-success btn-sm" onclick="showAcceptForm('${r.Id}')">Bid</button>`;
    } else {
      buttonHtml = `<button class="btn btn-success btn-sm" onclick="showAcceptForm('${r.Id}')">Bid</button>`;
    }

    const popupContent = `...`; // same as before
    L.marker(coord, {icon}).bindPopup(popupContent).addTo(markers);
  });

  document.getElementById("count").textContent = openCount;
}

// Keep all other functions: showAcceptForm, showOffers, submitOffer, confirmFixer, postForm
// Just replace currentUserPhone with currentUser.phone

</script>
</body>
</html>
