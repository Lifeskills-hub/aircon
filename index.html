<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SG Aircon Repair Help Board</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="data:,">
</head>
<body class="bg-light">
<div class="container py-5">

  <h1 class="text-primary mb-4">SG Aircon Repair Help Board</h1>

  <div class="card mb-4">
    <div class="card-body">
      <h3>Post New Request</h3>
      <form id="f" class="row g-3">
        <div class="col-md-6"><input class="form-control" placeholder="Your Name" required></div>
        <div class="col-md-6"><input class="form-control" placeholder="Phone" required></div>
        <div class="col-12"><input class="form-control" placeholder="Email (optional)"></div>
        <div class="col-12"><input class="form-control" placeholder="Location" required></div>
        <div class="col-12"><textarea class="form-control" rows="3" placeholder="Problem description" required></textarea></div>
        <div class="col-6"><input class="form-control" type="number" placeholder="Max budget (SGD)" required></div>
        <div class="col-12"><button class="btn btn-primary btn-lg">Post Request</button></div>
      </form>
    </div>
  </div>

  <h3>Open Requests</h3>
  <div id="list" class="row">Loading...</div>

</div>

<script>
// ────────────────────── CHANGE ONLY THIS LINE ──────────────────────
const API_URL = "https://script.google.com/macros/s/AKfycbxwUoET1X26ak4D1dtVGwMUFZpjl3ldPraf7i8VvYOBNqL0eK4znEsUHaQeFQVS6ewvcA/exec";
// ───────────────────────────────────────────────────────────────────

async function load() {
  const res = await fetch(API_URL + "?action=getRequests&ts=" + Date.now());
  const arr = await res.json();

  const div = document.getElementById("list");
  div.innerHTML = "";

  if (!Array.isArray(arr) || arr.length === 0) {
    div.innerHTML = "<p>No open requests right now.</p>";
    return;
  }

  arr.filter(r => r.Status === "Open").forEach(r => {
    const card = `
      <div class="col-md-6 mb-3">
        <div class="card">
          <div class="card-body">
            <h5>${r.Description}</h5>
            <p><strong>Location:</strong> ${r.Location}<br>
               <strong>Budget:</strong> S$${r.Budget}<br>
               <strong>Contact:</strong> ${r.Phone} ${r.Email ? "/ " + r.Email : ""}<br>
               <strong>Posted:</strong> ${new Date(r.Timestamp).toLocaleDateString()}</p>
            <button class="btn btn-success btn-sm" onclick="alert('Call ${r.Phone}\\nRequest ID: ${r['Request ID']}')">
              I Can Fix This
            </button>
          </div>
        </div>
      </div>`;
    div.innerHTML += card;
  });
}

document.getElementById("f").onsubmit = async e => {
  e.preventDefault();
  const inputs = e.target.elements;
  const data = {
    action: "submitRequest",
    name: inputs[0].value,
    phone: inputs[1].value,
    email: inputs[2].value,
    location: inputs[3].value,
    description: inputs[4].value,
    budget: inputs[5].value
  };

await fetch(API_URL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify(data)
});

load();   // ← This runs immediately when page opens
setInterval(load, 30000);
</script>
</body>
</html>
