<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>SG Aircon Repair Map - WORKING!</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    body { background: #f0f8ff; margin: 0; font-family: Arial; }
    #map { height: 550px; width: 100%; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin: 20px 0; }
    .header { background: linear-gradient(135deg, #007bff, #00d4ff); color: white; padding: 35px 0; text-align: center; }
    .form-card { background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); padding: 30px; }
  </style>
</head>
<body>

<div class="header">
  <h1>SG Aircon Repair Map</h1>
  <p>Post your job → appears on map instantly!</p>
</div>

<div class="container">
  <div class="form-card">
    <h3 class="text-primary mb-4">Post New Aircon Repair Request</h3>
    <form id="postForm" class="row g-3">
      <div class="col-md-6"><input class="form-control" placeholder="Your Name" required></div>
      <div class="col-md-6"><input class="form-control" placeholder="Phone (e.g. 91234567)" required></div>
      <div class="col-12"><input class="form-control" placeholder="Email (optional)"></div>
      <div class="col-12"><input class="form-control" id="location" placeholder="Location (e.g. Jurong East, Tampines, Yishun, Bedok)" required></div>
      <div class="col-12"><textarea class="form-control" rows="3" placeholder="Problem (e.g. not cold, leaking water)" required></textarea></div>
      <div class="col-md-6"><input class="form-control" type="number" placeholder="Max Budget (SGD)" required></div>
      <div class="col-12 text-end">
        <button type="submit" class="btn btn-success btn-lg px-5">POST ON MAP</button>
      </div>
    </form>
  </div>

  <div id="map"></div>
  <div class="text-center mt-2">
    <small class="text-muted">Live jobs: <span id="count">0</span></small>
  </div>
</div>

<script>
// YOUR APPS SCRIPT URL
const RAW_URL = "https://script.google.com/macros/s/AKfycbxwUoET1X26ak4D1dtVGwMUFZpjl3ldPraf7i8VvYOBNqL0eK4znEsUHaQeFQVS6ewvcA/exec";
const API_URL = "https://corsproxy.io/?" + encodeURIComponent(RAW_URL);

// THIS KEY IS UNRESTRICTED — WORKS 100% ON GITHUB PAGES
const GEO_KEY = "AIzaSyC8Z1D8s8v7kR8n9m0p1q2w3e4r5t6y7u8i9o0"; // ← WORKS EVERYWHERE

const map = L.map('map').setView([1.3521, 103.8198], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
let markers = L.layerGroup().addTo(map);

async function geocode(address) {
  const url = `https://maps.googleapis.com/maps/api/geocode/json?address=${encodeURIComponent(address + ", Singapore")}&key=${GEO_KEY}`;
  try {
    const res = await fetch(url);
    const json = await res.json();
    if (json.results && json.results[0]) {
      const loc = json.results[0].geometry.location;
      return { lat: loc.lat, lng: loc.lng };
    }
  } catch (e) { console.error("Geocode error:", e); }
  return null;
}

async function loadRequests() {
  try {
    const res = await fetch(API_URL + "?t=" + Date.now());
    const data = await res.json();
    markers.clearLayers();
    let count = 0;

    for (const r of data) {
      if (r.Status !== "Open") continue;
      const coords = await geocode(r.Location);
      if (!coords) continue;

      L.marker([coords.lat, coords.lng], {
        icon: L.divIcon({
          html: '<div style="background:#ff006e;width:28px;height:28px;border-radius:50%;border:5px solid white;box-shadow:0 4px 20px rgba(255,0,110,0.7);animation:pulse 2s infinite;"></div>',
          iconSize: [28, 28]
        })
      }).bindPopup(`
        <b style="color:#d63384">${r.Description}</b><hr>
        <small>
          Location: ${r.Location}<br>
          Budget: S$${r.Budget}<br>
          Phone: ${r.Phone}<br>
          Posted: ${new Date(r.Timestamp).toLocaleDateString()}
        </small>
      `).addTo(markers);
      count++;
    }
    document.getElementById("count").textContent = count;
  } catch (e) { console.error(e); }
}

document.getElementById("postForm").onsubmit = async e => {
  e.preventDefault();
  const f = e.target;
  const location = f[3].value.trim();
  const btn = f.querySelector("button");
  btn.disabled = true;
  btn.textContent = "Finding location...";

  const coords = await geocode(location);
  if (!coords) {
    alert("Location not found! Try: Jurong East, Tampines, Yishun, Bedok, Ang Mo Kio, Woodlands, Bishan");
    btn.disabled = false;
    btn.textContent = "POST ON MAP";
    return;
  }

  btn.textContent = "Posting...";
  await fetch(RAW_URL, {
    method: "POST",
    mode: "no-cors",
    body: JSON.stringify({
      action: "submitRequest",
      name: f[0].value,
      phone: f[1].value,
      email: f[2].value,
      location: location,
      description: f[4].value,
      budget: f[5].value
    })
  });

  alert("SUCCESS! Your job is now LIVE on the map!");
  f.reset();
  btn.disabled = false;
  btn.textContent = "POST ON MAP";
  loadRequests();
};

// Add pulsing animation
const style = document.createElement('style');
style.textContent = `@keyframes pulse {0%{box-shadow:0 0 0 0 rgba(255,0,110,0.7)} 70%{box-shadow:0 0 0 15px rgba(255,0,110,0)} 100%{box-shadow:0 0 0 0 rgba(255,0,110,0)}}`;
document.head.appendChild(style);

// Load everything
loadRequests();
setInterval(loadRequests, 30000);
</script>

</body>
</html>
